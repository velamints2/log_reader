# Docker Compose 配置文件
# 机器人日志分析系统

version: '3.8'

services:
  log-analyzer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: robot-log-analyzer
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      # 挂载日志目录 (持久化)
      - ./logs:/app/logs
      # 挂载报告目录 (持久化)
      - ./reports:/app/reports
      - ./temp_reports:/app/temp_reports
      - ./reports_new:/app/reports_new
      - ./final_reports:/app/final_reports
    environment:
      # 基础配置
      - LOG_DIRECTORY=/app/logs
      - REPORTS_DIRECTORY=/app/reports
      - TEMP_REPORTS_DIRECTORY=/app/temp_reports
      # DeepSeek API 配置 (可选 - 用于AI增强分析)
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - DEEPSEEK_BASE_URL=${DEEPSEEK_BASE_URL:-https://api.deepseek.com/v1}
      - DEEPSEEK_MODEL=${DEEPSEEK_MODEL:-deepseek-chat}
      - USE_DEEPSEEK=${USE_DEEPSEEK:-false}
      # OpenAI API 配置 (可选)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - BASE_URL=${BASE_URL:-https://api.openai.com/v1}
      # AI 参数
      - MAX_TOKENS=${MAX_TOKENS:-1000}
      - TEMPERATURE=${TEMPERATURE:-0.7}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-30}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# 可选：添加 Nginx 反向代理 (生产环境推荐)
#  nginx:
#    image: nginx:alpine
#    container_name: robot-log-nginx
#    restart: unless-stopped
#    ports:
#      - "80:80"
#      - "443:443"
#    volumes:
#      - ./nginx.conf:/etc/nginx/nginx.conf:ro
#      - ./ssl:/etc/nginx/ssl:ro
#    depends_on:
#      - log-analyzer

networks:
  default:
    name: log-analyzer-network
