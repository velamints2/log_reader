// å…¨å±€å˜é‡
let currentSection = 'dashboard';
let apiStatus = 'unknown';

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    loadSettings();
    updateStats();
    checkApiStatus();
});

// åˆå§‹åŒ–åº”ç”¨
function initializeApp() {
    // è®¾ç½®å¯¼èˆªç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.getAttribute('href').substring(1);
            showSection(target);
        });
    });

    // è®¾ç½®APIæä¾›å•†åˆ‡æ¢äº‹ä»¶
    const apiProviderSelect = document.getElementById('apiProvider');
    if (apiProviderSelect) {
        apiProviderSelect.addEventListener('change', function() {
            updateApiSettings();
        });
    }

    // è®¾ç½®AIå¯ç”¨å¤é€‰æ¡†äº‹ä»¶
    const enableAICheckbox = document.getElementById('enableAI');
    if (enableAICheckbox) {
        enableAICheckbox.addEventListener('change', function() {
            toggleAIProvider();
            toggleReportType();
        });
    }

    // åˆå§‹åŒ–AIæä¾›å•†é€‰æ‹©æ¡†çŠ¶æ€
    toggleAIProvider();
    toggleReportType();
}

// æ˜¾ç¤ºæŒ‡å®šåŒºåŸŸ
function showSection(sectionId) {
    // éšè—æ‰€æœ‰åŒºåŸŸ
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });

    // æ›´æ–°å¯¼èˆªé“¾æ¥çŠ¶æ€
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });

    // æ˜¾ç¤ºç›®æ ‡åŒºåŸŸ
    document.getElementById(sectionId).classList.add('active');
    document.querySelector(`[href="#${sectionId}"]`).classList.add('active');

    currentSection = sectionId;

    // ç‰¹å®šåŒºåŸŸçš„åˆå§‹åŒ–
    if (sectionId === 'reports') {
        loadReports();
    } else if (sectionId === 'dashboard') {
        updateStats();
    }
}

// æ˜¾ç¤ºåˆ†æåŒºåŸŸ
function showAnalysisSection() {
    showSection('analysis');
}

// æ˜¾ç¤ºæŠ¥å‘ŠåŒºåŸŸ
function showReportsSection() {
    showSection('reports');
}

// æ£€æŸ¥APIçŠ¶æ€
async function checkApiStatus() {
    const statusElement = document.getElementById('apiStatus');
    statusElement.textContent = 'æ£€æµ‹ä¸­...';
    statusElement.className = 'status-badge';

    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        if (data.status === 'success') {
            statusElement.textContent = 'å·²è¿æ¥';
            statusElement.className = 'status-badge connected';
            apiStatus = 'connected';
        } else {
            statusElement.textContent = 'è¿æ¥å¤±è´¥';
            statusElement.className = 'status-badge disconnected';
            apiStatus = 'disconnected';
        }
    } catch (error) {
        statusElement.textContent = 'è¿æ¥é”™è¯¯';
        statusElement.className = 'status-badge disconnected';
        apiStatus = 'error';
    }

    // æ›´æ–°AIçŠ¶æ€
    document.getElementById('aiStatus').textContent = apiStatus === 'connected' ? 'å°±ç»ª' : 'ç¦»çº¿';
}

// æµ‹è¯•APIè¿æ¥
async function testApiConnection() {
    const apiProvider = document.getElementById('apiProviderSelect').value;
    showNotification(`æ­£åœ¨æµ‹è¯•${apiProvider.toUpperCase()} APIè¿æ¥...`, 'info');
    
    try {
        const response = await fetch(`/api/test?provider=${apiProvider}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification(`âœ… ${apiProvider.toUpperCase()} APIè¿æ¥æµ‹è¯•æˆåŠŸï¼`, 'success');
        } else {
            showNotification(`âš ï¸ ${apiProvider.toUpperCase()} APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼š${data.message}`, 'warning');
        }
    } catch (error) {
        showNotification(`âŒ ${apiProvider.toUpperCase()} APIè¿æ¥æµ‹è¯•é”™è¯¯ï¼š${error.message}`, 'error');
    }
    
    checkApiStatus(); // åˆ·æ–°çŠ¶æ€
}

// æ˜¾ç¤º/éšè—AIæä¾›å•†é€‰æ‹©æ¡†
function toggleAIProvider() {
    const enableAIElement = document.getElementById('enableAI');
    const aiProviderGroup = document.getElementById('aiProviderGroup');
    
    if (!enableAIElement || !aiProviderGroup) {
        return; // å…ƒç´ ä¸å­˜åœ¨æ—¶ç›´æ¥è¿”å›
    }
    
    const enableAI = enableAIElement.checked;
    
    if (enableAI) {
        aiProviderGroup.style.display = 'block';
    } else {
        aiProviderGroup.style.display = 'none';
    }
}

// æ§åˆ¶æŠ¥å‘Šç±»å‹é€‰æ‹©æ¡†çš„æ˜¾ç¤º
function toggleReportType() {
    const enableAIElement = document.getElementById('enableAI');
    const reportTypeGroup = document.getElementById('reportTypeGroup');
    
    if (!enableAIElement || !reportTypeGroup) {
        return; // å…ƒç´ ä¸å­˜åœ¨æ—¶ç›´æ¥è¿”å›
    }
    
    const enableAI = enableAIElement.checked;
    
    if (enableAI) {
        reportTypeGroup.style.display = 'block';
    } else {
        reportTypeGroup.style.display = 'none';
    }
}

// å¼€å§‹æ—¥å¿—åˆ†æ
async function startAnalysis() {
    const logDirectoryElement = document.getElementById('logDirectory');
    const analysisTypeElement = document.getElementById('analysisType');
    const enableAIElement = document.getElementById('enableAI');
    const aiProviderElement = document.getElementById('aiProvider');
    const reportTypeElement = document.getElementById('reportType');

    // æ£€æŸ¥å¿…è¦å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!logDirectoryElement) {
        showNotification('âŒ é¡µé¢å…ƒç´ åŠ è½½é”™è¯¯ï¼šæ—¥å¿—ç›®å½•è¾“å…¥æ¡†ä¸å­˜åœ¨', 'error');
        return;
    }

    const logDirectory = logDirectoryElement.value;
    const analysisType = analysisTypeElement ? analysisTypeElement.value : 'comprehensive';
    const enableAI = enableAIElement ? enableAIElement.checked : false;
    const aiProvider = aiProviderElement ? aiProviderElement.value : 'openai';
    const reportType = reportTypeElement ? reportTypeElement.value : 'basic';

    if (!logDirectory) {
        showNotification('è¯·è¾“å…¥æ—¥å¿—ç›®å½•è·¯å¾„', 'warning');
        return;
    }

    // æ˜¾ç¤ºè¿›åº¦æ¡
    const progressElement = document.getElementById('analysisProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    // æ£€æŸ¥è¿›åº¦æ¡å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (progressElement && progressFill && progressText) {
        progressElement.style.display = 'block';
        progressFill.style.width = '0%';
        progressText.textContent = 'å‡†å¤‡å¼€å§‹åˆ†æ...';
    }

    try {
        // è°ƒç”¨åç«¯APIè¿›è¡Œå®é™…åˆ†æ
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                log_directory: logDirectory,
                enable_ai: enableAI,
                api_provider: aiProvider,  // æ–°å¢APIæä¾›å•†å‚æ•°
                report_type: reportType    // æ–°å¢æŠ¥å‘Šç±»å‹å‚æ•°
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // æ›´æ–°è¿›åº¦æ¡
            if (progressFill && progressText) {
                progressFill.style.width = '100%';
                progressText.textContent = 'åˆ†æå®Œæˆï¼';
            }
            
            // æ˜¾ç¤ºåˆ†æç»“æœ
            showAnalysisResults(data.report);
            showNotification('âœ… æ—¥å¿—åˆ†æå®Œæˆï¼', 'success');
            
            // è‡ªåŠ¨åˆ‡æ¢åˆ°æŠ¥å‘Šé¡µé¢å¹¶åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨
            setTimeout(() => {
                showSection('reports');
                loadReports();
            }, 1000);
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        showNotification('âŒ åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š' + error.message, 'error');
        if (progressElement) {
            progressElement.style.display = 'none';
        }
    }
}

// æ¨¡æ‹Ÿåˆ†æè¿‡ç¨‹
async function simulateAnalysis(progressFill, progressText) {
    const steps = [
        { progress: 10, text: 'æ­£åœ¨æ‰«ææ—¥å¿—æ–‡ä»¶...' },
        { progress: 30, text: 'è§£ææ—¥å¿—æ ¼å¼...' },
        { progress: 50, text: 'æ£€æµ‹å¼‚å¸¸æ¨¡å¼...' },
        { progress: 70, text: 'åˆ†ææ€§èƒ½æŒ‡æ ‡...' },
        { progress: 90, text: 'ç”Ÿæˆåˆ†ææŠ¥å‘Š...' },
        { progress: 100, text: 'åˆ†æå®Œæˆï¼' }
    ];

    for (const step of steps) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        progressFill.style.width = step.progress + '%';
        progressText.textContent = step.text;
    }
}

// æ˜¾ç¤ºåˆ†æç»“æœ
function showAnalysisResults(report) {
    const resultsElement = document.getElementById('analysisResults');
    const resultsContent = document.getElementById('resultsContent');
    
    if (report) {
        // æ˜¾ç¤ºå®é™…çš„åˆ†ææŠ¥å‘Š
        resultsContent.innerHTML = `
            <div class="result-item">
                <h4>ğŸ“Š åˆ†ææŠ¥å‘Š</h4>
                <pre style="white-space: pre-wrap; background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto;">${report}</pre>
            </div>
        `;
    } else {
        // å¦‚æœæ²¡æœ‰æŠ¥å‘Šæ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
        resultsContent.innerHTML = `
            <div class="result-item">
                <h4>ğŸ“Š åˆ†ææ‘˜è¦</h4>
                <p>â€¢ æ‰«æäº† 25 ä¸ªæ—¥å¿—æ–‡ä»¶</p>
                <p>â€¢ æ£€æµ‹åˆ° 8 ä¸ªå¼‚å¸¸äº‹ä»¶</p>
                <p>â€¢ è¯†åˆ«äº† 3 ä¸ªæ€§èƒ½ç“¶é¢ˆ</p>
                <p>â€¢ ç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Š</p>
            </div>
            <div class="result-item">
                <h4>ğŸ” å…³é”®å‘ç°</h4>
                <p>â€¢ æœºå™¨äººå®šä½ç³»ç»Ÿç¨³å®šæ€§è‰¯å¥½</p>
                <p>â€¢ å¯¼èˆªæ¨¡å—å­˜åœ¨å“åº”å»¶è¿Ÿ</p>
                <p>â€¢ ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†æ­£å¸¸</p>
            </div>
        `;
    }
    
    resultsElement.style.display = 'block';
}

// ç”ŸæˆæŠ¥å‘Š
function generateReport() {
    showNotification('æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...', 'info');
    
    // æ¨¡æ‹ŸæŠ¥å‘Šç”Ÿæˆ
    setTimeout(() => {
        showNotification('âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼', 'success');
        showSection('reports');
        loadReports();
    }, 2000);
}

// åŠ è½½æŠ¥å‘Šåˆ—è¡¨
async function loadReports() {
    const reportsGrid = document.getElementById('reportsGrid');
    const noReports = document.getElementById('noReports');
    
    try {
        const response = await fetch('/api/reports');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const reports = await response.json();
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯å“åº”
        if (reports.status && reports.status === 'error') {
            throw new Error(reports.message || 'è·å–æŠ¥å‘Šåˆ—è¡¨å¤±è´¥');
        }
        
        // ç¡®ä¿ reports æ˜¯æ•°ç»„
        const reportList = Array.isArray(reports) ? reports : [];
        
        if (reportList.length > 0) {
            noReports.style.display = 'none';
            reportsGrid.innerHTML = reportList.map(report => `
                <div class="report-card">
                    <h4>${report.title || 'æœªå‘½åæŠ¥å‘Š'}</h4>
                    <div class="report-meta">
                        <span>ğŸ“… ${report.date || 'æœªçŸ¥æ—¥æœŸ'}</span>
                        <span>ğŸ“Š ${report.type || 'æœªçŸ¥ç±»å‹'}</span>
                        <span>ğŸ“ ${report.size || '0 KB'}</span>
                    </div>
                    <p>${report.description || 'æ— æè¿°'}</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="viewReport('${report.id}')">æŸ¥çœ‹</button>
                        <button class="btn-secondary" onclick="downloadReport('${report.id}')">ä¸‹è½½</button>
                    </div>
                </div>
            `).join('');
        } else {
            noReports.style.display = 'block';
            noReports.innerHTML = `
                <i class="fas fa-folder-open"></i>
                <p>æš‚æ— æŠ¥å‘Šæ–‡ä»¶</p>
                <small>è¯·å…ˆè¿›è¡Œæ—¥å¿—åˆ†æç”ŸæˆæŠ¥å‘Š</small>
            `;
        }
    } catch (error) {
        console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', error);
        noReports.style.display = 'block';
        noReports.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <p>åŠ è½½æŠ¥å‘Šæ—¶å‡ºç°é”™è¯¯</p>
            <small>${error.message}</small>
        `;
    }
}

// åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨
function refreshReports() {
    showNotification('æ­£åœ¨åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨...', 'info');
    loadReports();
    setTimeout(() => {
        showNotification('âœ… æŠ¥å‘Šåˆ—è¡¨å·²åˆ·æ–°', 'success');
    }, 1000);
}

// æŸ¥çœ‹æŠ¥å‘Š
async function viewReport(reportId) {
    showNotification(`æ­£åœ¨æ‰“å¼€æŠ¥å‘Š ${reportId}...`, 'info');
    
    try {
        // è·å–æŠ¥å‘Šè¯¦æƒ…
        const response = await fetch(`/api/reports/${reportId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const reportData = await response.json();
        
        if (reportData.status && reportData.status !== 'success') {
            throw new Error(reportData.message || 'è·å–æŠ¥å‘Šå¤±è´¥');
        }
        
        if (reportData.content) {
            // åœ¨æ–°çª—å£æ‰“å¼€æŠ¥å‘Š
            const reportWindow = window.open('', '_blank');
            
            if (!reportWindow) {
                throw new Error('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥å¼¹çª—è®¾ç½®');
            }
            
            if (reportData.file_type === 'html') {
                // å¦‚æœæ˜¯HTMLæŠ¥å‘Šï¼Œç›´æ¥å†™å…¥å†…å®¹
                reportWindow.document.write(reportData.content);
                reportWindow.document.close();
            } else {
                // å¦‚æœæ˜¯æ–‡æœ¬æŠ¥å‘Šï¼Œåˆ›å»ºç®€å•çš„HTMLé¡µé¢æ˜¾ç¤ºå†…å®¹
                reportWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${reportData.filename || 'æ—¥å¿—åˆ†ææŠ¥å‘Š'}</title>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            pre { background: #f5f5f5; padding: 15px; border-radius: 5px; white-space: pre-wrap; overflow-x: auto; }
                            h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                        </style>
                    </head>
                    <body>
                        <h1>${reportData.filename || 'æ—¥å¿—åˆ†ææŠ¥å‘Š'}</h1>
                        <pre>${reportData.content}</pre>
                    </body>
                    </html>
                `);
                reportWindow.document.close();
            }
            
            showNotification('âœ… æŠ¥å‘Šå·²åœ¨æ–°çª—å£æ‰“å¼€', 'success');
        } else {
            throw new Error('æŠ¥å‘Šå†…å®¹ä¸ºç©º');
        }
    } catch (error) {
        console.error('æŸ¥çœ‹æŠ¥å‘Šå¤±è´¥:', error);
        showNotification('âŒ æ‰“å¼€æŠ¥å‘Šæ—¶å‡ºç°é”™è¯¯: ' + error.message, 'error');
    }
}

// ä¸‹è½½æŠ¥å‘Š
async function downloadReport(reportId) {
    showNotification(`æ­£åœ¨ä¸‹è½½æŠ¥å‘Š ${reportId}...`, 'info');
    
    try {
        // ä¸‹è½½æŠ¥å‘Šæ–‡ä»¶
        const response = await fetch(`/api/reports/${reportId}/download`);
        
        if (!response.ok) {
            if (response.headers.get('Content-Type')?.includes('application/json')) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ä¸‹è½½æŠ¥å‘Šå¤±è´¥');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }
        
        // è·å–æ–‡ä»¶å
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `report_${reportId}`;
        
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="(.+)"/);
            if (filenameMatch) {
                filename = filenameMatch[1];
            }
        }
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('âœ… æŠ¥å‘Šä¸‹è½½å®Œæˆ', 'success');
    } catch (error) {
        console.error('ä¸‹è½½æŠ¥å‘Šå¤±è´¥:', error);
        showNotification('âŒ ä¸‹è½½æŠ¥å‘Šæ—¶å‡ºç°é”™è¯¯: ' + error.message, 'error');
    }
}

// æµè§ˆç›®å½•
function browseDirectory() {
    showNotification('ç›®å½•æµè§ˆåŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ', 'info');
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
}

// æ›´æ–°APIè®¾ç½®æ˜¾ç¤º
function updateApiSettings() {
    const apiProvider = document.getElementById('apiProvider');
    const baseUrlInput = document.getElementById('baseUrl');
    
    if (!apiProvider || !baseUrlInput) {
        console.warn('APIè®¾ç½®å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    const provider = apiProvider.value;
    
    if (provider === 'deepseek') {
        baseUrlInput.value = 'https://api.deepseek.com';
        baseUrlInput.placeholder = 'DeepSeek APIåŸºç¡€URL';
    } else {
        baseUrlInput.value = 'https://api5.xhub.chat/v1';
        baseUrlInput.placeholder = 'OpenAI APIåŸºç¡€URL';
    }
}

// ä¿å­˜è®¾ç½®
function saveSettings() {
    const apiProvider = document.getElementById('apiProvider').value;
    const apiKey = document.getElementById('apiKey').value;
    const baseUrl = document.getElementById('baseUrl').value;
    const logPath = document.getElementById('logPath').value;
    const reportPath = document.getElementById('reportPath').value;
    
    const settings = {
        api_provider: apiProvider,
        api_key: apiKey,
        base_url: baseUrl,
        log_path: logPath,
        report_path: reportPath,
        api_type: apiProvider
    };
    
    // å…ˆä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    const localSettings = {
        apiProvider: apiProvider,
        apiKey: apiKey,
        baseUrl: baseUrl,
        logPath: logPath,
        reportPath: reportPath
    };
    
    localStorage.setItem('robotAnalyzerSettings', JSON.stringify(localSettings));
    updateApiSettings();
    
    // ä¿å­˜è®¾ç½®åˆ°åç«¯
    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('âœ… è®¾ç½®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°åç«¯', 'success');
            updateApiKeyStatus();
        } else {
            showNotification('âŒ ä¿å­˜è®¾ç½®å¤±è´¥: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        showNotification('âŒ ä¿å­˜è®¾ç½®å¤±è´¥', 'error');
    });
}

// æµ‹è¯•è®¾ç½®
async function testSettings() {
    const apiProvider = document.getElementById('apiProvider');
    const apiKey = document.getElementById('apiKey');
    const baseUrl = document.getElementById('baseUrl');
    
    if (!apiProvider || !apiKey || !baseUrl) {
        showNotification('âš ï¸ è®¾ç½®å…ƒç´ æœªæ‰¾åˆ°', 'warning');
        return;
    }
    
    // è·å–è¾“å…¥å€¼
    const provider = apiProvider.value || 'openai';
    const keyValue = apiKey.value.trim();
    const urlValue = baseUrl.value.trim();
    
    // éªŒè¯è¾“å…¥
    if (!keyValue) {
        showNotification('âš ï¸ è¯·è¾“å…¥APIå¯†é’¥', 'warning');
        apiKey.focus();
        return;
    }
    
    if (!urlValue) {
        showNotification('âš ï¸ è¯·è¾“å…¥APIåŸºç¡€URL', 'warning');
        baseUrl.focus();
        return;
    }
    
    if (!urlValue.startsWith('http://') && !urlValue.startsWith('https://')) {
        showNotification('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„APIåŸºç¡€URL', 'warning');
        baseUrl.focus();
        return;
    }
    
    showNotification('æ­£åœ¨æµ‹è¯•APIè¿æ¥...', 'info');
    
    try {
        const testData = {
            api_provider: provider,
            api_key: keyValue,
            base_url: urlValue,
            model: provider === 'deepseek' ? 'deepseek-chat' : 'gpt-3.5-turbo'
        };
        
        // è°ƒç”¨åç«¯æµ‹è¯•API
        const response = await fetch('/api/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showNotification('âœ… ' + result.message + ' - å³å°†ä¿å­˜è®¾ç½®', 'success');
            
            // å»¶è¿Ÿä¿å­˜è®¾ç½®ï¼Œä»¥ä¾¿ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
                const settings = {
                    apiProvider: provider,
                    apiKey: keyValue,
                    baseUrl: urlValue,
                    logPath: document.getElementById('logPath')?.value || './logs',
                    reportPath: document.getElementById('reportPath')?.value || './reports'
                };
                
                localStorage.setItem('robotAnalyzerSettings', JSON.stringify(settings));
                localStorage.removeItem('tempApiSettings');
                
                showNotification('âœ… APIé…ç½®æµ‹è¯•é€šè¿‡ä¸”å·²ä¿å­˜', 'success');
            }, 1000);
            
        } else {
            showNotification('âŒ ' + result.message, 'error');
        }
    } catch (error) {
        console.error('APIæµ‹è¯•å¤±è´¥:', error);
        showNotification('âŒ APIè¿æ¥å¤±è´¥: ' + error.message, 'error');
    }
}

// åŠ è½½è®¾ç½®
async function loadSettings() {
    // é¦–å…ˆå°è¯•ä»åç«¯åŠ è½½è®¾ç½®
    try {
        const response = await fetch('/api/settings');
        const result = await response.json();
        
        if (result.status === 'success' && result.settings) {
            const serverSettings = result.settings.settings || {};
            
            // æ›´æ–°è¡¨å•
            const apiProvider = document.getElementById('apiProvider');
            const apiKey = document.getElementById('apiKey');
            const baseUrl = document.getElementById('baseUrl');
            const logPath = document.getElementById('logPath');
            const reportPath = document.getElementById('reportPath');
            
            if (apiProvider) apiProvider.value = serverSettings.api_provider || 'openai';
            if (apiKey) apiKey.value = serverSettings.api_key || '';
            if (baseUrl) baseUrl.value = serverSettings.base_url || '';
            if (logPath) logPath.value = serverSettings.log_path || './logs';
            if (reportPath) reportPath.value = serverSettings.report_path || './reports';
            
            updateApiKeyStatus();
            return;
        }
    } catch (error) {
        console.error('ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥:', error);
    }
    
    // å¦‚æœåç«¯æ²¡æœ‰è®¾ç½®ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å‚¨
    const savedSettings = localStorage.getItem('robotAnalyzerSettings');
    
    if (!savedSettings) {
        return;
    }
    
    try {
        const settings = JSON.parse(savedSettings);
        
        const apiProvider = document.getElementById('apiProvider');
        const apiKey = document.getElementById('apiKey');
        const baseUrl = document.getElementById('baseUrl');
        const logPath = document.getElementById('logPath');
        const reportPath = document.getElementById('reportPath');
        
        if (apiProvider) apiProvider.value = settings.apiProvider || 'openai';
        if (apiKey) apiKey.value = settings.apiKey || '';
        if (baseUrl) baseUrl.value = settings.baseUrl || '';
        if (logPath) logPath.value = settings.logPath || './logs';
        if (reportPath) reportPath.value = settings.reportPath || './reports';
        
        updateApiKeyStatus();
    } catch (error) {
        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
    }
}

// æ›´æ–°APIå¯†é’¥çŠ¶æ€æ˜¾ç¤º
async function updateApiKeyStatus() {
    const apiKeyInput = document.getElementById('apiKey');
    const apiStatus = document.getElementById('aiStatus');
    
    if (!apiKeyInput) return;
    
    const apiKey = apiKeyInput.value;
    
    if (apiKey) {
        // æ˜¾ç¤ºAPIå¯†é’¥çš„çŠ¶æ€ï¼ˆéƒ¨åˆ†éšè—ï¼‰
        const maskedKey = apiKey.substring(0, 8) + '*'.repeat(Math.min(20, apiKey.length - 8));
        if (apiStatus) {
            apiStatus.textContent = 'å·²é…ç½®';
            apiStatus.className = 'stat-value success';
        }
    } else {
        if (apiStatus) {
            apiStatus.textContent = 'æœªé…ç½®';
            apiStatus.className = 'stat-value error';
        }
    }
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
async function updateStats() {
    try {
        // è·å–æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
        const logsResponse = await fetch('/api/logs');
        const logFiles = await logsResponse.json();
        
        // è·å–æŠ¥å‘Šæ–‡ä»¶åˆ—è¡¨
        const reportsResponse = await fetch('/api/reports');
        const reports = await reportsResponse.json();
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        const logCount = document.getElementById('logCount');
        const anomalyCount = document.getElementById('anomalyCount');
        const reportCount = document.getElementById('reportCount');
        
        if (logCount) logCount.textContent = logFiles.length || 0;
        if (anomalyCount) anomalyCount.textContent = '8'; // æš‚æ—¶ä¿æŒæ¨¡æ‹Ÿæ•°æ®
        if (reportCount) reportCount.textContent = reports.length || 0;
    } catch (error) {
        console.error('æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
        // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
        const logCount = document.getElementById('logCount');
        const anomalyCount = document.getElementById('anomalyCount');
        const reportCount = document.getElementById('reportCount');
        
        if (logCount) logCount.textContent = '0';
        if (anomalyCount) anomalyCount.textContent = '0';
        if (reportCount) reportCount.textContent = '0';
    }
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    const messageElement = document.getElementById('notificationMessage');
    
    if (!notification || !messageElement) {
        console.warn('é€šçŸ¥å…ƒç´ æœªæ‰¾åˆ°:', message);
        return;
    }
    
    messageElement.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    
    // 5ç§’åè‡ªåŠ¨éšè—
    setTimeout(hideNotification, 5000);
}

// éšè—é€šçŸ¥
function hideNotification() {
    const notification = document.getElementById('notification');
    
    if (!notification) {
        return;
    }
    
    notification.style.display = 'none';
}

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case '1':
                e.preventDefault();
                showSection('dashboard');
                break;
            case '2':
                e.preventDefault();
                showSection('analysis');
                break;
            case '3':
                e.preventDefault();
                showSection('reports');
                break;
            case '4':
                e.preventDefault();
                showSection('settings');
                break;
        }
    }
});